/*
 * JQuery manyform plugin 0.1
 *
 * Copyright (c) 2008 - 2009 Sam Anzaroot
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
*/
(function($) {
	
	// Link that enables forms
	var enablelink,
			div,
			sets;
	
	$.manyform = {
		defaults: {
			message : 'Activate the Form.',
			name : 'manyform',
			max : 10,
			parentID: '',
			// *num* in form will be replaced with the number of the form
			form : '',
			onadd : null,
			attrib: 'Activater',
			transShow : 'slideDown',
			transHide : 'slideUp'
		}
	};
	
	$.fn.extend({
		manyform: function(settings) {
			$['many' + settings.name] = $.extend({}, $.manyform.defaults , settings);
			console.log(settings.name);
			var sets = $['many' + settings.name];
		  var $this = $(this);
		  message = '<a href = "javascript:void(0);" id = "enable' + settings.name + '" class = "enable' + settings.name + '" >' + settings.message + '</a>';
			if($('#div' + settings.name).length) {
				$('.add' + settings.name).bind('click', add);
				$('.remove' + settings.name).bind('click', remove);
			} else {
			  $this.after('<div id = "div' + settings.name + '"></div>');
				$this.after(message);
				$['many' + settings.name].enablelink = $('#enable' + settings.name);
				$['many' + settings.name].enablelink.one('click', add);
		  }
			$this.hide();
			$['many' + settings.name].div = $('#div' + settings.name);
		}
	});
	
 	function add(e) {
	  setName = 'many' + e.target.className;
	 	setName = setName.replace(/enable/, '');
	 	setName = setName.replace(/add/, '');
		sets = $[setName];
		if(sets.enablelink)
			sets.enablelink.remove();
		e.preventDefault();
		looking = 'enable' + sets.name;
		if($(this).attr('id') == looking){
       var num = 0;
       var set = false;
    } else {
       var num = parseFloat( $(this).attr('id').replace('add' + sets.name, '') );
       var set = true;
    }
    num++;
		if(num > sets.max) return false;
		field = '<fieldset id = "' + sets.name + num + '" style = "display:none;">';
		var adder = sets.form.replace(/\*num\*/g, num);
		adder = adder.replace(/\*parent\*/g, sets.parentID);
		field += adder;
		field += '</fieldset>';
		sets.div.append(field);
		fieldset = $('#' + sets.name + num);
		fieldset.slideDown('slow');
    fieldset.before('<a href = "javascript:void(0);" id = "remove' + sets.name + num +'" class = "remove' + sets.name + '" >Remove ' + sets.attrib + ' &darr;<\/a>');
		fieldset.after('<a href = "javascript:void(0);" style = "display:none" id = "add' + sets.name + num + '" class = "add' + sets.name + '">Add ' + sets.attrib + '<\/a>');
    $( '#add' + sets.name + num ).bind( 'click', add );
		$( '#remove' + sets.name + num).bind('click', remove);
    if( num <= ( sets.max - 1) )
       $( '#add' + sets.name + num ).show();
		if(set)
			$('#remove' + sets.name + (num-1)).remove();
		$('#add' + sets.name + (num-1)).remove();
		if(sets.onadd != null) sets.onadd(num);
    
	}
	
	function remove(e) {
		 setName = 'many' + e.target.className;
	 	 setName = setName.replace(/remove/, '');
		 sets = $[setName];
     var num = parseFloat( $(this).attr('id').replace('remove' + sets.name, ''));
     $( '#' + sets.name + num ).slideUp( 'slow', function() { $( '#' + sets.name + num ).remove() } );
     $(this).remove();
     $( '#add' + sets.name + num ).attr('id', 'add' + sets.name + ( num - 1 ) ).show();
     $( '#' + sets.name + (num - 1) ).before('<a href = "javascript:void(0);" id = "remove' + sets.name + ( num - 1 ) +'" class = "remove' + sets.name + '" >Remove ' + sets.attrib + ' &darr;<\/a>');
     $( '#remove' + sets.name + ( num - 1) ).bind( 'click', remove );
  }

	
})(jQuery);